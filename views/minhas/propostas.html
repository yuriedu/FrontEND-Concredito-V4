<div id="propostasPage" style="max-height: 100vh; overflow: auto; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh">
  <navbar id="navbar"></navbar>
  <script>$("#navbar").load(`/imports/navbar.html`)</script>

  <div class="background-image margin-left2-5 width79 min-height33" style="margin-top: 12.5vh; margin-left: 6vw; width: 92.5vw; min-height: 37vh; border-radius: 2vh">
    <a style="display: flex; width: 100%; justify-content: center; padding-top: 2vh; font-size: 3vh">Filtro de Propostas:</a>
    <div style="width: 100%; display: flex; flex-direction: row; justify-content: center; font-size: 1.7vh;">
      <fieldset title="Fase atual da proposta..." style="padding: 0; border-radius: 0.6vh; width: 25%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Fase</legend>
        <select id="fase" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0">
          <option style="color: black" value="" selected>Todas</option>
          <optgroup style="color: black!important" label="Principais">
            <option style="color: black" value="1">Inclusão sem Conferência</option>
          </optgroup>
          <optgroup style="color: black!important" label="Robô">
            <option style="color: black" value="822">Aguardando Digitação - ROBO</option>
            <option style="color: black" value="15">Em Digitação - ROBO</option>
            <option style="color: black" value="824">Não Digitado - ROBO</option>
            <option style="color: black" value="823">Digitado Sucesso - ROBO</option>
          </optgroup>
          <optgroup style="color: black!important" label="Esteira">
            <option style="color: black" value="2">Aguardando Averbação</option>
            <option style="color: black" value="9">Pêndente</option>
            <option style="color: black" value="692">Analise Banco</option>
            <option style="color: black" value="4002">Assinado/Respondido</option>
            <option style="color: black" value="1111">Atuação Master</option>
            <option style="color: black" value="90000">Aguarda Liberar Assinar</option>
            <option style="color: black" value="9923">Link Enviado ao Cliente</option>
            <option style="color: black" value="9232">Aguarda Assinatura Digital</option>
          </optgroup>
          <optgroup id="fasesAll" style="color: black!important" label="Agilus">
          </optgroup>
        </select>
      </fieldset>
      <fieldset title="Banco do Contrato da proposta..." style="padding: 0; border-radius: 0.6vh; width: 25%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Banco</legend>
        <select id="bank" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0">
          <option style="color: black" value="" selected>Todos</option>
          <option style="color: black" value="2020">FACTA FINANCEIRA</option>
          <option style="color: black" value="626">BANCO C6</option>
          <option style="color: black" value="623">PANAMERICANO</option>
          <option style="color: black" value="389">MERCANTIL</option>
          <option style="color: black" value="318">BMG</option>
          <option style="color: black" value="422">SAFRA</option>
          <option style="color: black" value="41">BANRISUL</option>
          <option style="color: black" value="290">PagBank</option>
        </select>
      </fieldset>
      <fieldset title="Orgão do Contrato da proposta..." style="padding: 0; border-radius: 0.6vh; width: 25%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Orgão</legend>
        <select id="orgao" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0">
          <option style="color: black" value="" selected>Todos</option>
          <option style="color: black" value="23">FGTS</option>
          <option style="color: black" value="1">INSS</option>
          <option style="color: black" value="7">CARTÃO INSS</option>
        </select>
      </fieldset>
    </div>

    <div style="width: 100%; display: flex; flex-direction: row; justify-content: center; font-size: 1.7vh; font-size: 1.7vh;">
      <fieldset title="CPF do cliente..." style="padding: 0; border-radius: 0.6vh; width: 20%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">CPF</legend>
        <input id="cpf" type="number" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0" placeholder="000.000.000.00">
      </fieldset>
      <fieldset title="Codigo da AF..." style="padding: 0; border-radius: 0.6vh; width: 13%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Cod. AF</legend>
        <input id="codAF" type="number" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0" placeholder="000000">
      </fieldset>
      <fieldset title="Codigo do Contrato..." style="padding: 0; border-radius: 0.6vh; width: 13%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Cod. Contr<span class="invisibleAndroid">ato</span></legend>
        <input id="codContrato" type="number" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0" placeholder="00000000">
      </fieldset>
      <fieldset title="Orgão do Contrato da proposta..." style="padding: 0; border-radius: 0.6vh; width: 25%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Tipo de Mídia</legend>
        <select id="midia" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0">
          <option style="color: black" value="" selected>Todas</option>
          <option value="menos27" style="color: black; font-weight: 600;">Todas menos API</option>
          <option value="27" style="color: black; font-weight: 600;">API</option>
          <option value="1" style="color: black; font-weight: 600;">Fechado em Ligação</option>
          <option value="2" style="color: black; font-weight: 600;">WhatsApp</option>
          <option value="3" style="color: black; font-weight: 600;">MKT Digital</option>
          <option value="4" style="color: black; font-weight: 600">Indicação</option>
          <option value="5" style="color: black; font-weight: 600">Cliente da Carteira</option>
          <option value="6" style="color: black; font-weight: 600">Radio</option>
          <option value="7" style="color: black; font-weight: 600">Presencial</option>
          <option value="8" style="color: black; font-weight: 600">Robo Whats</option>
          <option value="9" style="color: black; font-weight: 600">Retorno SMS</option>
          <option value="25" style="color: black; font-weight: 600">Repescagem</option>
          <option value="26" style="color: black; font-weight: 600">Instagram</option>
          <option value="28" style="color: black; font-weight: 600">Cap. por Lig. e Fec. Whats</option>
        </select>
      </fieldset>
    </div>
    <div style="width: 100%; display: flex; flex-direction: row; justify-content: center; font-size: 1.7vh;">
      <fieldset title="Data Minima..." style="padding: 0; border-radius: 0.6vh; width: 25%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Data Inicio</legend>
        <input id="dateIni" type="date" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0">
      </fieldset>
      <fieldset title="Data Maxima..." style="padding: 0; border-radius: 0.6vh; width: 25%; margin-inline: 1%; padding-inline: 1%;">
        <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Data Final</legend>
        <input id="dateEnd" type="date" style="font-size: 2.1vh; width: 100%; height: 3vh; padding:0; margin:0; background: transparent; border: 0">
      </fieldset>
    </div>
    <div style="width: 100%; display: flex; justify-content: center">
      <div id="filter" onclick="filter()" class="buttonLogin" style="width: 30%; margin-top: 3vh; font-size: 2.8vh; padding-block: 1.5vh; border-radius: 1.5vh">
        <a>Filtrar</a>
      </div>
    </div>
  </div>

  <div class="background-image margin-left2-5 width79" style="margin-top: 3vh; display: flex; margin-left: 6vw; width: 92.5vw; min-height: 12vh; border-radius: 2vh; text-align: center; justify-content: center; align-items: center; font-size: 1.7vh;">
    <fieldset class="width60p" title="Pesquise alguma proposta por aqui..." style="padding: 0; margin: 0; border-radius: 0.6vh; width: 50%; margin-inline: 1%; padding-inline: 1%;">
      <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Pesquisar</legend>
      <input onkeyup="searchBar()" id="searchBar" placeholder="Pesquise alguma proposta aqui..." style="padding:0; margin:0; font-size: 2.5vh; width: 100%; height: 4vh; background: transparent; border: 0">
    </fieldset>
    <i onclick="searchBar()" class="fa-regular fa-magnifying-glass-dollar" style="font-size: 3.5vh; margin-top: 1.5vh; cursor: pointer"></i>
  </div>

  <div class="background-image margin-left2-5 width79 min-height36-5" style="margin-top: 3vh; margin-left: 6vw; width: 92.5vw; min-height: 32.5vh; border-top-left-radius: 2vh; border-top-right-radius: 2vh;">
    <div id="propostas-lista" style="margin-inline: 3%; padding-block: 2%;">
      <a class="line-bottom font-size2" style="font-size: 3vh; display: flex; margin-inline: 20%; width: 60%; justify-content: center">Nenhuma proposta encontrada...</a>
    </div>
  </div>
  <div id="menuPropostas"></div>

  <div id="acomp" class="background-reverse left18-5 width79 font-color-reverse" style="display: none; z-index: 5; position: fixed; top: 15%; left: 20%; width: 60%; border-radius: 3vh;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; ">
      <div id="listAcomp" style="width: 100%; display: flex; flex-direction: column; align-items: center; max-height: 60vh; overflow: auto">
      </div>
      <div id="textAcomp" style="width: 100%; display: flex; flex-direction: row; justify-content: center; max-height: 18%; overflow: hidden; margin-bottom: 2vh">
      </div>
    </div>
  </div>

</div>

<script>
const fasesName = {
  '1': 'Inclusão sem conferência',
  '2': 'AGUARDANDO AVERBAÇÃO',
  '9': 'PENDENTE',
  '11': 'Aguardando Retorno CIP',
  '12': 'Pendência Resolvida',
  '15': 'EM DIGITAÇÃO-ROBO',
  '69': 'DAR ANUÊNCIA',
  '323': 'AGUARDA AUMENTO INSS',
  '692': 'PROPOSTA EM ANALISE BANCO',
  '700': 'REPROVADO',
  '822': 'AGUARDANDO DIGITAÇÃO AUTOMÁTICA - ROBÔ',
  '823': 'DIGITADO SUCESSO - ROBÔ',
  '824': 'NÃO DIGITADO --ERRO-- ROBÔ',
  '1111': 'AGUARDANDO ATUAÇÃO MASTER',
  '1234': 'OP - CADASTRAR MANUAL',
  '2002': 'CLIENTE RECEBEU',
  '3920': 'PROPOSTA PAGA',
  '4002': 'ASSINADO / RESPONDIDO',
  '9232': 'AGUARDANDO ASSINATURA DIGITAL',
  '9923': 'LINK ENVIADO AO CLIENTE',
  '90000': 'Aguarda Liberar Assinar',
  '10293': 'Verificação manual OP',
  '100023': 'PAGAMENTO DEVOLVIDO',
  '120001': 'PENDENTE POR ASSINATURA',
  '202552': 'Envia Requisição CIP',
}

  var menuPropostaActual = false
  function menuPropostas(icon, codAF, bank) {
    if (menuPropostaActual) {
      document.getElementById(`menuProposta`).innerHTML = ``
      if (menuPropostaActual == codAF) return menuPropostaActual = false
      menuPropostaActual = false
    }
    menuPropostaActual = codAF
    document.getElementById(`menuPropostas`).innerHTML = `
      <div id="menuProposta">
        <div class="background-reverse width35" style="z-index: 2; width: 8vw; border-radius: 1.5vh; font-size: 2vh; position: absolute; top: ${$(icon).offset().top+document.getElementById('propostasPage').scrollTop}px; left: calc(${$(icon).offset().left}px - (${window.screen.width < 900 ? '35.2vw' : '8.8vw'}) ); display: flex; flex-direction: column; text-align: center; padding-block: 0.8vh">
          <a onclick="getAcomp('${codAF}')" class="line-bottom-reverse navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">Acompanhamento</a>
          <a onclick="whatsapp('${codAF}')" class="line-bottom-reverse navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">WhatsApp</a>
          <a onclick="fgts('${codAF}',1)" class="line-bottom-reverse navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">Consultar FGTS</a>
          <select onchange="changeFase('${codAF}',this.value)" class="font-color-reverse navbar-color-select" style="font-weight: 500; font-size: 2vh;padding: 0; margin: 0; cursor: pointer; padding-block: 0.3vh; background: transparent; border: none; text-align: center; display: flex; width: 100%; justify-content: center; align-items: center">
            <option style="color: black" value="" selected>Trocar Fase</option>
            <option style="color: black" value="1">Inclusão sem conferência</option>
            <option style="color: black" value="9923">Link de assinatura enviado ao cliente</option>
            <option style="color: black" value="4002">Assinado/Respondido</option>
            <option style="color: black" value="2002">Cliente Recebeu</option>
          </select>
        </div>
      </div>
    `
  }
  var propostas = []
  function filter() {
    if (document.getElementById('filter').classList.contains('buttonBlock')) return alert('Aguarde...')
    document.getElementById('filter').innerHTML = `<i class="fad fa-spinner-third fa-spin"></i>`
    document.getElementById('filter').classList.add("buttonBlock");
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    document.getElementById('propostas-lista').innerHTML = `<div style="width: 100%; height: 30vh; display: flex; justify-content: center; align-items: center"><div class="loader-wheel"></div><div class="loader-text font-5"></div></div>`
    $.ajax({ type: "post", url: `${apiURL}/propostas/afs/lista`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      agente: localStorage.getItem('user'),
      fase: document.getElementById('fase') && document.getElementById('fase').value ? document.getElementById('fase').value : false,
      bank: document.getElementById('bank') && document.getElementById('bank').value ? document.getElementById('bank').value : false,
      orgao: document.getElementById('orgao') && document.getElementById('orgao').value ? document.getElementById('orgao').value : false,
      cpf: document.getElementById('cpf') && document.getElementById('cpf').value ? document.getElementById('cpf').value : false,
      codAF: document.getElementById('codAF') && document.getElementById('codAF').value ? document.getElementById('codAF').value : false,
      codContrato: document.getElementById('codContrato') && document.getElementById('codContrato').value ? document.getElementById('codContrato').value : false,
      midia: document.getElementById('midia') && document.getElementById('midia').value ? document.getElementById('midia').value : false,
      dateIni: document.getElementById('dateIni') && document.getElementById('dateIni').value ? document.getElementById('dateIni').value : false,
      dateEnd: document.getElementById('dateEnd') && document.getElementById('dateEnd').value ? document.getElementById('dateEnd').value : false,
    }),contentType:"application/json; charset=utf-8",
      success: function(s) {
        document.getElementById('filter').innerHTML = `<p class="font-1">Filtrar</p>`
        document.getElementById('filter').classList.remove("buttonBlock");
        document.getElementById('propostas-lista').innerHTML = `<a class="line-bottom" style="font-size: 3vh; display: flex; margin-inline: 20%; width: 60%; justify-content: center">Nenhuma proposta encontrada...</a>`
        if (s.error) return alert(s.error)
        if (s.propostas && s.propostas.length >= 1) {
          document.getElementById('propostas-lista').innerHTML = ``
          propostas = s.propostas
          s.propostas.forEach((element,index)=>{
            if (element.codOrgaoAF == 23) element.orgaoName = "FGTS"
            if (element.codOrgaoAF == 1) element.orgaoName = "INSS"
            if (element.codOrgaoAF == 7) element.orgaoName = "CARTÃO INSS"
            if (!element.orgaoName) element.orgaoName = "???"
            document.getElementById('propostas-lista').innerHTML += `<proposta><a style="display:none">${JSON.stringify(element)}</a><div id="proposta_${element.codAF}" class="background-Propostas" style="z-index: 1; position: relative; border-radius: 1.5vh; margin-block: 2.5vh"><div class="line-bottom navbar-font-color font-4" style="display: flex; flex-direction: row; align-items: center; height: 6vh; font-size: 2.2vh; padding-inline: 1%;"><a class="max-width30p" title="${element.bancoAF}" style="max-width: 15%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="far fa-landmark font-size2"></i><span class="invisibleAndroid"> BANCO: </span>${element.bancoAF}</a><a class="max-width30p" title="${element.orgaoName}" style="max-width: 15%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="far fa-bookmark font-size2"></i><span class="invisibleAndroid"> ORGÃO: </span>${element.orgaoName}</a><a class="invisibleAndroid" title="${element.valorAF}" style="max-width: 15%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="far fa-sack-dollar font-size2"></i><span class="invisibleAndroid"> VL. AF: </span>${element.valorAF}</a><a class="invisibleAndroid" title="${element.parcela}" style="max-width: 15%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="fal fa-table font-size2"></i><span class="invisibleAndroid"> PARCELAS: </span>${element.parcela}</a><a class="max-width30p" title="${element.codAF}" style="max-width: 15%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="far fa-file-code font-size2"></i><span class="invisibleAndroid"> COD. AF: </span>${element.codAF}</a><a class="invisibleAndroid" title="${element.Tabela}" style="max-width: 15%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="far fa-table font-size2"></i><span class="invisibleAndroid"> TABELA: </span>${element.Tabela}</a><i id="menu_${element.codAF}" onclick="menuPropostas(this, ${element.codAF}, '${element.bancoAF}')" class="fa-solid fa-ellipsis-vertical font-size2 navbar-color-select" style="padding-inline: 1vw; cursor: pointer; position: absolute; right: 1%"></i></div><div style="display: flex; flex-direction: row; align-items: center; height: 9.5vh; font-size: 2.2vh; padding-inline: 1%;"><fieldset class="width30p" title="${element.nome}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 18%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Nome</legend><input disabled value="${element.nome}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="width30p" title="${element.cpf}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 8%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">CPF</legend><input disabled value="${element.cpf}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="invisibleAndroid" title="${element.rg}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 5%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">RG</legend><input disabled value="${element.rg}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="invisibleAndroid" title="${element.cep}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 6%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">CEP</legend><input disabled value="${element.cep}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="invisibleAndroid" title="${element.codBanco}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 10%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Banco</legend><input disabled value="${element.codBanco}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="invisibleAndroid" title="${element.agencia}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 3%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Agência</legend><input disabled value="${element.agencia}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="invisibleAndroid" title="${element.contaCorrente}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 5%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Conta</legend><input disabled value="${element.contaCorrente}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><fieldset class="width30p" id="title_${element.codAF}" title="Fase: ${fasesName[element.codFase] ? fasesName[element.codFase] : element.codFase}" style="padding: 0; margin: 0; border-radius: 0.6vh; width: 20.5%; margin-left: 0.5%; padding-inline: 1%;"><legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Situação</legend><input id="situation_${element.codAF}" disabled value="Fase: ${fasesName[element.codFase] ? fasesName[element.codFase] : element.codFase}" style="font-size: 2.1vh; width: 100%; height: 3.5vh; padding:0; margin:0; background: transparent; border: 0"></fieldset></div></proposta>`
            if (element.codFase == 15) return situation(element.codAF, element.bancoAF)
          })
        }
      },
      error: function(e) {
        document.getElementById('filter').innerHTML = `<p class="font-1">Filtrar</p>`
        document.getElementById('filter').classList.remove("buttonBlock");
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    });
  }
  function situation(codAF, bank) {
    if (document.getElementById(`situation_${codAF}`).style.color == 'red' || document.getElementById(`situation_${codAF}`).style.color == "green" || document.getElementById(`situation_${codAF}`).style.color == "orange") return;
    $.ajax({ type: "post", url: `${apiURL}/propostas/situation`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      proposta: codAF,
      bank: bank,
      actual: document.getElementById(`situation_${codAF}`) ? document.getElementById(`situation_${codAF}`).value : false
    }),contentType:"application/json; charset=utf-8",
      success: function(s) {
        if (s.error) {
          document.getElementById(`situation_${codAF}`).style.color = `red`
          document.getElementById(`situation_${codAF}`).value = s.error
          return document.getElementById(`title_${codAF}`).title = s.error
        } else if (s.position) {
          document.getElementById(`situation_${codAF}`).value = `Aguardando na fila - `+s.position
          document.getElementById(`title_${codAF}`).title = `Aguardando na fila - `+s.position
          return situation(codAF, bank)
        } else if (s.start) {
          document.getElementById(`situation_${codAF}`).value = 'Iniciando Cadastro...'
          document.getElementById(`title_${codAF}`).title = 'Iniciando Cadastro...'
          return situation(codAF, bank)
        } else if (s.value) {
          document.getElementById(`situation_${codAF}`).style.color = `blue`
          document.getElementById(`situation_${codAF}`).value = s.value
          document.getElementById(`title_${codAF}`).title = s.value
          return situation(codAF, bank)
        } else if (s.notFound && document.getElementById(`situation_${codAF}`).style.color != 'red' && document.getElementById(`situation_${codAF}`).style.color != "green" && document.getElementById(`situation_${codAF}`).style.color != "orange") {
          document.getElementById(`situation_${codAF}`).style.color = `orange`
          return document.getElementById(`situation_${codAF}`).value = 'Cadastro Finalizado...'
        }
      }, 
      error: function(e) {
        if (e.responseJSON && e.responseJSON.error) {
          document.getElementById(`situation_${codAF}`).style.color = `red`
          document.getElementById(`situation_${codAF}`).value = e.responseJSON.error
          return document.getElementById(`title_${codAF}`).title = e.responseJSON.error
        }
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    })
  }

  var acompMenu = false
  function closeAcomp() {
    acompMenu = false
    document.getElementById('acomp').style.display = 'none'
  }

  var getAcompBlock = false
  function getAcomp(codAF) {
    if (getAcompBlock || acompMenu) return alert('Aguarde...')
    getAcompBlock = true
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    $.ajax({ type: "post", url: `${apiURL}/propostas/afs/acomp`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      proposta: codAF
    }),contentType:"application/json; charset=utf-8",
      success: function(s) {
        getAcompBlock = false
        if (s.error) return alert(s.error)
        acompMenu = true
        document.getElementById('textAcomp').innerHTML = `
          <fieldset id="fieldset" title="Nova Descrição" style="margin-top: 2vh; text-align: left; padding: 0; border-radius: 0.6vh; width: 85%; margin-inline: 1%; padding-inline: 1%;">
            <legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Novo Acompanhamento</legend>
            <textarea rows="3" class="font-1 font-color-reverse" placeholder="Coloque um novo acompanhamento nessa proposta..." id="newAcomp" style="font-size: 2.4vh; width: 100%; padding:0; margin:0; background: transparent; border: 0"></textarea>
          </fieldset>
          <div title="Enviar" style="width: 4%; max-width: 4%; text-align: center; padding-block: 0.7vh; display: flex; justify-content: center; align-items: center;">
            <i onclick="newAcomp('${codAF}')" class=" fa-solid fa-paper-plane-top font-color-navbar-reverse" style="cursor: pointer; font-size: 4vh; font-weight: 600; margin-top: 0.2vh"></i>
          </div>
        `
        document.getElementById('listAcomp').innerHTML = `
          <div style="display: flex; width: 100%; border-bottom: 0.1vh solid gray; padding-top: 0.3vh">
            <div title="Data" style="width: 15%; max-width: 15%; padding-left: 2%; height: 100%; padding-block: 0.7vh">
              <a style="font-size: 2.5vh; font-weight: 800">Data</a>
            </div>
            <div title="Nome" style="width: 25%; max-width: 25%; padding-left: 2%; border-left: 0.1vh solid gray; padding-block: 0.7vh">
              <a style="font-size: 2.5vh; font-weight: 800">Nome</a>
            </div>
            <div title="Descrição" style="width: 50%; max-width: 50%; padding-left: 2%; border-left: 0.1vh solid gray; padding-block: 0.7vh">
              <a style="font-size: 2.5vh; font-weight: 800">Descrição</a>
            </div>
            <div title="Fechar" style="width: 4%; max-width: 4%; border-left: 0.1vh solid gray; text-align: center; padding-block: 0.7vh;">
              <i onclick="closeAcomp()" class="far fa-times" style="cursor: pointer; font-size: 3.2vh; color: red; font-weight: 600; margin-top: 0.2vh"></i>
            </div>
          </div>
        `
        s.acomps.reverse().forEach((element,i)=>{
          document.getElementById('listAcomp').innerHTML += `
          <div id="acomp_${element.id}" style="display: flex; width: 100%; border-bottom: 0.1vh solid gray;">
            <div title="Data" style="width: 15%; max-width: 15%; overflow: hidden; padding-left: 2%; padding-block: 0.5vh; display: flex; align-items: center;">
              <a style="font-size: 1.8vh">${element.data.slice(8,10)}/${element.data.slice(5,7)}/${element.data.slice(0,4)} ${element.data.slice(11,16)}</a>
            </div>
            <div title="Nome" style="width: 25%; max-width: 25%; overflow: hidden; padding-left: 2%; border-left: 0.1vh solid gray; padding-block: 0.5vh; display: flex; align-items: center;">
              <a style="font-size: 1.8vh; font-weight: 800">${element.agente}</a>
            </div>
            <div title="Descrição" style="width: 50%; max-width: 50%; overflow: hidden; padding-left: 2%; border-left: 0.1vh solid gray; padding-block: 0.5vh; display: flex; align-items: center;">
              <a style="font-size: 1.8vh">${element.descricao.replaceAll('\n','<br/>')}</a>
            </div>
            <div title="Fechar" style="width: 4%; max-width: 4%; border-left: 0.1vh solid gray; text-align: center; padding-block: 0.5vh">
              <i onclick="deleteAcomp('${codAF}','${element.id}')" class="fa-solid fa-trash-xmark" style="cursor: pointer; font-size: 1.8vh; color: red; font-weight: 600"></i>
            </div>
          </div>
          `
        })
        document.getElementById('acomp').style.display = 'flex'
      },
      error: function(e) {
        getAcompBlock = false
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    });
  }

  var acompDeleteBlock = false
  function deleteAcomp(codAF, codAcomp) {
    if (acompDeleteBlock) return alert('Aguarde...')
    if (!codAF || !codAcomp) return alert('Codigo de AF/Acomp não definido...')
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    acompDeleteBlock = true
    $.ajax({ type: "post", url: `${apiURL}/propostas/afs/remAcomp`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      codAF: codAF,
      codAcomp: codAcomp
    }),contentType:"application/json; charset=utf-8",
      success: function(s) {
        acompDeleteBlock = false
        if (s.error) return alert(s.error)
        alert('Acompanhamento apagado com sucesso...')
        document.getElementById(`acomp_${codAcomp}`).style.setProperty('color', 'red', 'important');
      },
      error: function(e) {
        acompDeleteBlock = false
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    })
  }
  function newAcomp(codAF) {
    if (acompDeleteBlock) return alert('Aguarde...')
    if (!codAF) return alert('Codigo de AF não definido...')
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    if (!document.getElementById('newAcomp').value) return alert('Escreva o que você desejas colocar no acompanhamento...')
    acompDeleteBlock = true
    $.ajax({ type: "post", url: `${apiURL}/propostas/afs/newAcomp`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      codAF: codAF,
      descricao: document.getElementById('newAcomp').value
    }),contentType:"application/json; charset=utf-8",
      success: async function(s) {
        acompDeleteBlock = false
        if (s.error) return alert(s.error)
        alert('Acompanhamento inserido com sucesso...')
        await closeAcomp();
        return getAcomp(codAF); 
      },
      error: function(e) {
        acompDeleteBlock = false
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    })
  }




  async function whatsapp(codAF) {
    var af = propostas.find(r=> r.codAF == codAF)
    if (!af) return alert('Proposta não encontrada...')
    var mensagem = `ConCredito Consignados`
    if (af.codFase == 9232) {
      mensagem = `
Olá ${af.nome.toUpperCase()}! Tudo bem? 
Eu tenho uma *EXCELENTE NOTÍCIA*! 🤩

Liberou novos valores pra você, e você tem *R$${String(af.valorAF).replace('.',',')}* para receber agora pela manhã, e por você já ser meu cliente vou conseguir uma *prioridade no seu pagamento!*

Apenas assine pelo link abaixo:
${af.link}
      `   
    } else if (af.codFase == 9923) {
      mensagem = `
Percebi que você não assinou o contrato ainda! 
O banco me informou que se você assinar agora dá prioridade no seu pagamento! Consegue fazer agora e receber ainda hoje esses *R$${String(af.valorAF).replace('.',',')}*?

Link: ${af.link}
      `   
    } else return alert('A proposta tem que estar na fase "AGUARDANDO ASSINATURA DIGITAL" ou "LINK DE ASSINATURA ENVIADO PARA O CLIENTE"...')
  
    if (window.clipboardData) {
      await window.clipboardData.setData("Text", mensagem);
    } else {
      await navigator.clipboard.writeText(mensagem).catch(()=>{ 
        return alert('Seu navegador não suporta o nossos sistema de Copia...')
      })
    }
    return window.open(`https://wa.me/55${String(af.telefone).replaceAll('(','').replaceAll(')','').replaceAll('-','').replaceAll(' ','')}`, '_blank');
  }

  var changeFaseActive = false
  function changeFase(codAF,fase) {
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    if (!fase) return alert('Selecione alguma fase...')
    if (changeFaseActive) return alert('Você já está alterando a fase de alguma proposta! Aguarde...')
    changeFaseActive = true
    $.ajax({ type: "post", url: `${apiURL}/propostas/afs/fase`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      proposta: codAF,
      fase: fase,
    }),contentType:"application/json; charset=utf-8",
      success: function(s) {
        changeFaseActive = false
        if (s.error) return alert(s.error)
        alert(`A proposta: ${codAF} teve sua fase alterada com sucesso!`)
      },
      error: function(e) {
        changeFaseActive = false
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    });
  }

  var banks = {
    "FACTA FINANCEIRA": { option1: "GOLD" },
    "BANCO C6": { option1: 'POR_VALOR_TOTAL' },
    "PANAMERICANO": { option1: 'POR_VALOR_TOTAL', option3: '900001' },
    "SAFRA": { option1: 'POR_VALOR_TOTAL', option1: '1' },
    "MERCANTIL": { option1: 'POR_VALOR_TOTAL' },
    "BMG": { option1: 'POR_VALOR_TOTAL' },
  }

  function fgts(codAF,fase) {
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    if (changeFaseActive) return alert('Você já está com algo em andamento! Aguarde...')
    var proposta = propostas.find(r=>r.codAF == codAF)
    if (!proposta || !banks[proposta.bancoAF]) return alert('Banco não encontrado em minha API...')
    return window.open(`/consultas/fgts?cpf=${proposta.cpf}&bank=${proposta.bancoAF}`, '_blank');
    // changeFaseActive = true
    // $.ajax({ type: "post", url: `${apiURL}/consultas/fgts`, data: JSON.stringify({
    //   user: localStorage.getItem('user'),
    //     password: localStorage.getItem('password'),
    //     cpf: proposta.cpf,
    //     bank: proposta.bancoAF,
    //     option1: banks[proposta.bancoAF].option1 ? banks[proposta.bancoAF].option1 : false,
    //     option2: banks[proposta.bancoAF].option2 ? banks[proposta.bancoAF].option2 : false,
    //     option3: banks[proposta.bancoAF].option3 ? banks[proposta.bancoAF].option3 : false,
    // }),contentType:"application/json; charset=utf-8",
    //   success: function(s) {
    //     changeFaseActive = false
    //     if (s.error) return alert(s.error)
    //     alert(`CPF consultado com sucesso...\nSaldo Liberado: ${s.saldoLiberado}\nSaldo Total: ${s.saldoTotal}`)
    //   },
    //   error: function(e) {
    //     changeFaseActive = false
    //     if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
    //     return alert(`A minha API demorou muito para retornar uma resposta valida...`)
    //   }
    // });
  }

  var blockFase = false
  function getFases() {
    if (blockFase) return alert('Aguarde...')
    blockFase = true
    if (menuPropostaActual) menuPropostas(false, menuPropostaActual)
    $.ajax({ type: "post", url: `${apiURL}/propostas/afs/getFases`, data: JSON.stringify({
      user: localStorage.getItem('user'), 
      password: localStorage.getItem('password'),
      proposta: codAF,
      fase: fase,
    }),contentType:"application/json; charset=utf-8",
      success: function(s) {
        blockFase = false
        s.fases.forEach((element,i)=>{
          document.getElementById('fasesAll').innerHTML += `<option value="${element.codFase}" style="color: black">${element.Fase}</option>`
        })
      },
      error: function(e) {
        blockFase = false
        if (e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`A minha API demorou muito para retornar uma resposta valida...`)
      }
    });
  }

  (function () { getFases(); filter() })();
</script>
<script>
    function searchBar() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById('searchBar');
    filter = input.value.toUpperCase();
    ul = document.getElementById("propostas-lista");
    li = ul.getElementsByTagName('proposta');
    for (i = 0; i < li.length; i++) {
      a = li[i]
      txtValue = a.textContent || a.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "inline";
      } else {
        li[i].style.display = "none";
      }
    }
  }
</script>