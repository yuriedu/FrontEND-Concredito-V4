<div id="propostasPage" style="max-height: 100vh; overflow: auto; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh">
  <navbar id="navbar"></navbar>
  <script>$("#navbar").load(`/views/imports/navbar.html`)</script>

  <div class="background-image margin-left18-5 width79 " style="margin-top: 12.5vh; margin-left: 6vw; width: 92.5vw; height: 13%; border-radius: 2vh;display: flex; flex-direction: row; justify-content: center; align-items: center;">
    <fieldset title="Pesquise algum funcionario por aqui..." style="padding: 0; margin: 0; border-radius: 0.6vh; width: 50%; margin-inline: 1%; padding-inline: 1%;">
      <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Pesquisar</legend>
      <input onkeyup="searchBar()" id="searchBar" placeholder="Pesquise algum funcionario aqui..." style="padding:0; margin:0; font-size: 2.5vh; width: 100%; height: 4vh; background: transparent; border: 0">
    </fieldset>
    <i onclick="searchBar()" class="fa-regular fa-magnifying-glass-dollar" style="font-size: 3.5vh; margin-top: 1.5vh; cursor: pointer"></i>
  </div>

  <div class="background-image margin-left18-5 width79 " style="margin-top: 2vh; margin-left: 6vw; width: 92.5vw; min-height: 64.5%; border-top-left-radius: 2vh; border-top-right-radius: 2vh; display: flex; flex-direction: column; padding-block: 4vh">
    <div id="loading">
      <div style="width: 100%; display: flex; justify-content: center; align-items: center"><div class="loader-wheel"></div><div class="loader-text font-5"></div></div>
    </div>
    <div id="funcionarios" style="display: none; margin-inline: 3vw"></div>
    <div id="menuPropostas"></div>
    <div>
      <div class="font-color-navbar background-reverse" style="z-index: 5; cursor: pointer; position: fixed; bottom: 2vh; right: 3vw; padding-block: 1vh; display: flex; align-items: center; justify-content: center; border-radius: 2vh"><fieldset id="fieldset" title="Novo Funcionário..." style="text-align: left; padding: 0; border-radius: 0.6vh; width: 60%; margin-inline: 1%; padding-inline: 1%; margin-right: 1vw;"><legend class="font-4 font-size1-5" style="margin: 0; padding: 0; font-size: 2.3vh">Novo Funcionário</legend><input class="font-1 font-color-reverse" placeholder="Nome do Funcionário" id="newFuncInput" style="font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0"></fieldset><i class="fa-regular fa-user-plus" style="font-size: 4vh" onclick="createFunc()"></i></div></div>
    </div>
    <div id="menuFuncs" class="background-reverse left18-5 width79" style="display: none; position: fixed; width: 70%; height: 70%; left: 15%; top: 15%; z-index: 5; border-radius: 4vh; max-height: 70%; overflow: auto">
      <div style="position: relative">
        <a style="width: 100%; display: flex; justify-content: center; font-size: 4vh; margin-top: 3vh">Funcionário: <span id="resultNameFunc" class="font-color-navbar-reverse" style="margin-left: 1vw;"></span></a>
        <i onclick="openMenuFunc()" class="fas fa-times" style="cursor: pointer; position: absolute; right: 2vw; top: 1vh; font-size: 4vh"></i>
        <div style="display: flex; width: 100%; justify-content: center">
          <fieldset id="fieldset" title="Pesquise algum CPF por aqui..." style="padding: 0; margin: 0; border-radius: 0.6vh; width: 60%; margin-inline: 1%; padding-inline: 1%;">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Pesquisar</legend>
            <input onkeyup="searchBar2()" class="font-color-reverse" id="searchBar2" placeholder="Pesquise algum CPF aqui..." style="padding:0; margin:0; font-size: 2.5vh; width: 100%; height: 4vh; background: transparent; border: 0">
          </fieldset>
        </div>
        <div id="result" style="padding-inline: 5%">

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function searchBar() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById('searchBar');
    filter = input.value.toUpperCase();
    ul = document.getElementById("funcionarios");
    li = ul.getElementsByTagName('proposta');
    for (i = 0; i < li.length; i++) {
      a = li[i]
      txtValue = a.textContent || a.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "inline";
      } else {
        li[i].style.display = "none";
      }
    }
  }
  function searchBar2() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById('searchBar2');
    filter = input.value.toUpperCase();
    ul = document.getElementById("result");
    li = ul.getElementsByTagName('result');
    for (i = 0; i < li.length; i++) {
      a = li[i]
      txtValue = a.textContent || a.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "inline";
      } else {
        li[i].style.display = "none";
      }
    }
  }
  var getingUser = false

  var usersList = []
  var fgtsList = []
  var cadastrosList = []
  function getUser() {
    if (getingUser) return alert('Você já está com um puxamento em andamento...')
    getingUser = true
    $.ajax({ type: "post",url: `http://localhost:3000/funcionarios/getLogins`,
      data: JSON.stringify({
        user: localStorage.getItem('user'),
        password: localStorage.getItem('password'),
      }), contentType:"application/json; charset=utf-8",
      success: async function(s) {
        getingUser = false
        if (s.error) return alert(s.error)
        s.logins.forEach((element,index)=>{
          document.getElementById('funcionarios').innerHTML += `<proposta><a style="display:none">${JSON.stringify(element)}</a><div id="user_${element.user}" class="background-Propostas" style="z-index: 1; position: relative; border-radius: 1.5vh; margin-block: 2.5vh"><div class="line-bottom navbar-font-color font-4" style="display: flex; flex-direction: row; align-items: center; height: 6vh; font-size: 2.2vh; padding-inline: 1%; justify-content: center; position: relative">

            <i style="position: absolute; right: 1.5vw; cursor: pointer" onclick="menuPropostas(this, '${element.user}')" class="fa-solid fa-ellipsis-vertical font-color-navbar"></i>

            <a title="${element.user}" style="margin-inline: 2%; max-width: 25%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="fa-regular fa-user-headset"></i><span class="invisibleAndroid"> Funcionário: </span><span>${element.user}</span></a>
            <a title="${element.agente}" style="margin-inline: 2%; max-width: 25%; margin-left: 0.8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="fa-solid fa-user-tie-hair font-size2"></i><span class="invisibleAndroid"> Agente: </span><span>${element.agente}</span></a>
          </div>
          <div class="flex-direction-column" style="display: flex; flex-direction: row; align-items: center; min-height: 10vh; font-size: 2.2vh; padding-inline: 1%; justify-content: center;">
            <fieldset class="width60p" style="padding: 0; width: 25%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
              <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Email</legend>
              <input class="font-1" id="${element.user}_email" placeholder="${element.email}" style="font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
            </fieldset>
            <fieldset class="width60p" style="padding: 0; width: 20%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
              <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Nova Senha</legend>
              <input class="font-1" id="${element.user}_password" placeholder="..." style="font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
            </fieldset>
            <fieldset class="width60p" style="padding: 0; width: 10%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
              <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Cod. Agilus</legend>
              <input class="font-1" type="number" id="${element.user}_codigo" placeholder="${element.codigo}" style="font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
            </fieldset>
            <fieldset class="width60p" style="padding: 0; width: 20%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
              <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Cargo</legend>
              <input class="font-1" id="${element.user}_role" placeholder="${element.role}" style="font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
            </fieldset>
          </div></div></proposta>`
        })
        fgtsList = s.fgts
        cadastrosList = s.cadastros
        document.getElementById('loading').style.display = 'none'
        document.getElementById(`funcionarios`).style.display = 'inline'
      },
      error: function(e) {
        getingUser = false
        if (e.error) return alert(e.error)
        if (e && e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`Ocorreu algum erro indefinido! Mande print do erro para o Yuri:\n ${JSON.stringify(e)}`)
      }
    })
  }

  var menuPropostaActual = false
  function menuPropostas(icon, codAF) {
    if (menuPropostaActual) {
      document.getElementById(`menuProposta`).innerHTML = ``
      if (menuPropostaActual == codAF) return menuPropostaActual = false
      menuPropostaActual = false
    }
    menuPropostaActual = codAF
    document.getElementById(`menuPropostas`).innerHTML = `<div id="menuProposta"><div class="background-reverse width35" style="z-index: 2; width: 8vw; border-radius: 1.5vh; font-size: 2vh; position: absolute; top: ${$(icon).offset().top+document.getElementById('propostasPage').scrollTop}px; left: calc(${$(icon).offset().left}px - (${window.screen.width < 900 ? '35.2vw' : '8.2vw'}) ); display: flex; flex-direction: column; text-align: center; padding-block: 0.8vh">
      <a onclick="salvar('${codAF}')" class="line-bottom-reverse navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">Salvar</a>
      <a onclick="deleteFunc('${codAF}')" class="line-bottom-reverse navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">Deletar</a>
      <a onclick="openMenuFunc('${codAF}','fgts')" class="line-bottom-reverse navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">Consultas FGTS</a>
      <a onclick="openMenuFunc('${codAF}','cadastros')" class="navbar-color-select" style="cursor: pointer; padding-block: 0.6vh">Cadastros</a>
    </div></div>`
  }

  menuFunc = false
  function openMenuFunc(id, menu) {
    if (menuFunc) {
      menuFunc = false
      document.getElementById('menuFuncs').style.display = 'none'
    } else {
      menuFunc = true
      document.getElementById('menuFuncs').style.display = 'inline'
      document.getElementById('resultNameFunc').innerHTML = id
      document.getElementById('result').innerHTML = ``
      if (menu == 'fgts') {
        document.getElementById('result').innerHTML += `<a style="font-size: 2.5vh; margin-top: 3vh; width: 100%; display: flex; justify-content: center">Sucessos: <span class="font-color-navbar-reverse" style="margin-left: 0.5vw; margin-right: 5vw">${fgtsList.filter(r=>r.user == id && !r.error).length}</span> Erros:<span style="margin-left: 0.5vw" class="font-color-navbar-reverse">${fgtsList.filter(r=>r.user == id && r.error).length}</span></a>`
        document.getElementById('result').innerHTML += `<a onclick="limpar('${id}','fgts')" class="font-color-navbar-reverse" style="font-size: 2.5vh; margin-top: 3vh; width: 100%; display: flex; justify-content: center; cursor: pointer; text-decoration: underline">Limpar</a>`
        fgtsList.filter(r=>r.user == id && !r.error).forEach((element,index)=>{
          document.getElementById('result').innerHTML += `<result><a style="display:none">${JSON.stringify(element)}</a><div class="background-Propostas" style="z-index: 1; position: relative; border-radius: 1.5vh; margin-block: 2.5vh">
          <div class="flex-direction-column font-color" style="color: black!important; display: flex; flex-direction: row; align-items: center; min-height: 10vh; font-size: 2.2vh; padding-inline: 1%; justify-content: center;">
          <fieldset class="width60p" style="padding: 0; width: 15%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">CPF</legend>
            <input disabled class="font-1" value="${element.cpf}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 15%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Banco</legend>
            <input disabled class="font-1" value="${element.bank}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 10%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Liberado</legend>
            <input disabled class="font-1" value="${element.liberado}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 10%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Total</legend>
            <input disabled class="font-1" value="${element.total}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 20%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Data</legend>
            <input class="font-1" value="${element.data.replace('T',' - ').replace('Z','')}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0" disabled>
          </fieldset>
          </div></div></result>`
        })
        fgtsList.filter(r=>r.user == id && r.error).forEach((element,index)=>{
          document.getElementById('result').innerHTML += `<result><a style="display:none">${JSON.stringify(element)}</a><div class="background-Propostas" style="z-index: 1; position: relative; border-radius: 1.5vh; margin-block: 2.5vh">
          <div class="flex-direction-column font-color" style="color: black!important; display: flex; flex-direction: row; align-items: center; min-height: 10vh; font-size: 2.2vh; padding-inline: 1%; justify-content: center;">
          <fieldset class="width60p" style="padding: 0; width: 15%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">CPF</legend>
            <input disabled class="font-1" value="${element.cpf}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 15%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Banco</legend>
            <input disabled class="font-1" value="${element.bank}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 40%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Erro</legend>
            <input disabled class="font-1" value="${element.error}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          </div></div></result>`
        })
      } else if (menu == "cadastros") {
        document.getElementById('result').innerHTML += `<a style="font-size: 2.5vh; margin-top: 3vh; width: 100%; display: flex; justify-content: center">Cadastros: <span class="font-color-navbar-reverse" style="margin-left: 0.5vw;">${cadastrosList.filter(r=>r.user == id).length}</span></a>`
        document.getElementById('result').innerHTML += `<a onclick="limpar('${id}','cadastros')" class="font-color-navbar-reverse" style="font-size: 2.5vh; margin-top: 3vh; width: 100%; display: flex; justify-content: center; cursor: pointer; text-decoration: underline">Limpar</a>`
        cadastrosList.filter(r=>r.user == id).forEach((element,index)=>{
          document.getElementById('result').innerHTML += `<result><a style="display:none">${JSON.stringify(element)}</a><div class="background-Propostas" style="z-index: 1; position: relative; border-radius: 1.5vh; margin-block: 2.5vh">
          <div class="flex-direction-column font-color" style="color: black!important; display: flex; flex-direction: row; align-items: center; min-height: 10vh; font-size: 2.2vh; padding-inline: 1%; justify-content: center;">
          <fieldset class="width60p" style="padding: 0; width: 20%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">CPF</legend>
            <input disabled class="font-1" value="${element.af}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0">
          </fieldset>
          <fieldset class="width60p" style="padding: 0; width: 30%; margin: 0; border-radius: 0.6vh; margin-left: 0.5%; padding-inline: 0.4%; height: 7.7vh">
            <legend class="font-4" style="margin: 0; padding: 0; font-size: 2.3vh">Data</legend>
            <input class="font-1" value="${element.data.replace('T',' - ').replace('Z','')}" style="color: black!important;font-size: 2.4vh; width: 100%; height: 4vh; padding:0; margin:0; background: transparent; border: 0" disabled>
          </fieldset>
          </div></div></result>`
        })
      }
    }
  }

  var limpando = false
  function limpar(user, menu) {
    if (limpando) return alert('Você já está com um limpamento em andamento...')
    limpando = true
    $.ajax({ type: "post",url: `http://localhost:3000/funcionarios/clearCounts`,
      data: JSON.stringify({
        user: localStorage.getItem('user'),
        password: localStorage.getItem('password'),
        newUser: user,
        menu: menu,
      }), contentType:"application/json; charset=utf-8",
      success: async function(s) {
        limpando = false
        if (s.error) return alert(s.error)
        alert('Limpo com sucesso...')
        return window.location.reload()
      },
      error: function(e) {
        limpando = false
        if (e.error) return alert(e.error)
        if (e && e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`Ocorreu algum erro indefinido! Mande print do erro para o Yuri:\n ${JSON.stringify(e)}`)
      }
    })
  }

  var salavando = false
  function salvar(user) {
    if (salavando) return alert('Você já está com um salvamento em andamento...')
    salavando = true
    $.ajax({ type: "post",url: `http://localhost:3000/funcionarios/editLogin`,
      data: JSON.stringify({
        user: localStorage.getItem('user'),
        password: localStorage.getItem('password'),
        newUser: user,
        codigo: document.getElementById(`${user}_codigo`) ? document.getElementById(`${user}_codigo`).value : false,
        newPassword: document.getElementById(`${user}_password`) ? document.getElementById(`${user}_password`).value : false,
        newEmail: document.getElementById(`${user}_email`) ? document.getElementById(`${user}_email`).value : false,
        newRole: document.getElementById(`${user}_role`) ? document.getElementById(`${user}_role`).value : false,
      }), contentType:"application/json; charset=utf-8",
      success: async function(s) {
        salavando = false
        if (s.error) return alert(s.error)
        return alert('Salvo com sucesso...')
      },
      error: function(e) {
        salavando = false
        if (e.error) return alert(e.error)
        if (e && e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`Ocorreu algum erro indefinido! Mande print do erro para o Yuri:\n ${JSON.stringify(e)}`)
      }
    })
  }
  var creating = false
  function createFunc() {
    if (creating) return alert('Você já está com um criamento em andamento...')
    creating = true
    $.ajax({ type: "post",url: `http://localhost:3000/funcionarios/newLogin`,
      data: JSON.stringify({
        user: localStorage.getItem('user'),
        password: localStorage.getItem('password'),
        newUser: document.getElementById('newFuncInput').value
      }), contentType:"application/json; charset=utf-8",
      success: async function(s) {
        creating = false
        if (s.error) return alert(s.error)
        alert('Funcionario criado com sucesso...')
        return window.location.reload()
      },
      error: function(e) {
        creating = false
        if (e.error) return alert(e.error)
        if (e && e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`Ocorreu algum erro indefinido! Mande print do erro para o Yuri:\n ${JSON.stringify(e)}`)
      }
    })
  }
  var deleting = false
  function deleteFunc(user) {
    if (deleting) return alert('Você já está com um deletamento em andamento...')
    deleting = true
    $.ajax({ type: "post",url: `http://localhost:3000/funcionarios/deleteLogin`,
      data: JSON.stringify({
        user: localStorage.getItem('user'),
        password: localStorage.getItem('password'),
        deleteUser: user
      }), contentType:"application/json; charset=utf-8",
      success: async function(s) {
        deleting = false
        if (s.error) return alert(s.error)
        alert('Funcionario deletado com sucesso...')
        return window.location.reload()
      },
      error: function(e) {
        deleting = false
        if (e.error) return alert(e.error)
        if (e && e.responseJSON && e.responseJSON.error) return alert(e.responseJSON.error)
        return alert(`Ocorreu algum erro indefinido! Mande print do erro para o Yuri:\n ${JSON.stringify(e)}`)
      }
    })
  }
  (function () { getUser() })();
</script>